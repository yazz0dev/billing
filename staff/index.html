<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile Barcode Scanner</title>
    <link rel="stylesheet" href="/billing/global.css?v=<?php echo time(); ?>">
    <style>
        body {
            background-color: var(--bg-body); color: var(--text-primary);
            font-family: 'Inter', sans-serif; margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; min-height: 100vh; box-sizing: border-box;
        }
        .scanner-container { width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; text-align: center; }
        #scanner-region {
            width: 100%; max-width: 500px; min-height: 200px; /* Reduced min-height */
            border: 2px dashed var(--primary); background-color: var(--bg-surface-alt);
            margin: 15px auto; position: relative;
        }
        #scanner-region video { width: 100% !important; height: auto !important; }
        .status-message { margin-top: 10px; padding: 8px; border-radius: var(--border-radius-sm); font-weight: 500; font-size: 0.9em; }
        .status-message.success { background-color: var(--success-bg); color: var(--success-text-emphasis); border: 1px solid var(--success); }
        .status-message.error { background-color: var(--error-bg); color: var(--error-text-emphasis); border: 1px solid var(--error); }
        .status-message.info { background-color: var(--info-bg); color: var(--info-text-emphasis); border: 1px solid var(--info); }
        .btn {
            padding: .7rem 1.4rem; background-color: var(--primary); color: var(--text-on-primary);
            border: none; border-radius: var(--border-radius-sm); cursor: pointer;
            font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s;
        }
        .btn:hover { background-color: var(--primary-dark); }
        .btn:disabled { background-color: var(--border-color-strong); cursor: not-allowed; }
        .product-info { margin-top: 8px; font-size: 0.85em; color: var(--text-secondary); }
        #stopScannerBtn { background-color: var(--error); }
        #stopScannerBtn:hover { background-color: #b91c1c; }
        .controls { margin-top: 1rem; display: flex; gap: 10px; justify-content: center; }
        .scanner-page-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 1rem; }
        .scanner-page-header .user-info-scanner { font-size: 0.9rem; color: var(--text-secondary); }
         #recentScans { max-height: 150px; overflow-y: auto; font-size: 0.85rem;}
         #recentScansList li { padding: 2px 0; border-bottom: 1px dashed var(--border-color-subtle); }
         #recentScansList li:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="scanner-container">
        <div class="scanner-page-header">
            <h1 class="page-title" style="font-size: 1.5rem; margin-bottom: 0;">Scan Barcodes</h1>
            <a href="/billing/staff/mobile-pair.php" class="btn" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">Re-Pair</a>
            <!-- <span class="user-info-scanner">User: <?php /* echo isset($_SESSION['username']) ? htmlspecialchars($_SESSION['username']) : 'N/A'; */ ?></span> -->
        </div>
        
        <div id="scanner-activation" class="glass p-3 mb-3">
            <p id="scannerReadyMessage">Checking pairing status...</p>
            <button id="activateScannerBtn" class="btn" style="display:none;">Activate Scanner</button>
        </div>

        <div id="scanner-region" style="display:none;"></div>
        <div id="statusMessage" class="status-message info" style="display:none;"></div>
        <div id="lastScannedProduct" class="product-info"></div>

        <div class="controls" style="display:none;" id="scanControls">
            <button id="stopScannerBtn" class="btn">Stop Scanner</button>
        </div>

        <div id="recentScans" class="glass p-2 mt-2" style="display:none;">
            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Recent Scans:</h4>
            <ul id="recentScansList" style="list-style: none; padding: 0;"></ul>
        </div>
        <a href="/billing/logout.php" class="btn" style="background-color: var(--error); margin-top: 20px; font-size: 0.9rem;">Logout</a>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const activateScannerBtn = document.getElementById('activateScannerBtn');
            const stopScannerBtn = document.getElementById('stopScannerBtn');
            const scannerRegion = document.getElementById('scanner-region');
            const statusMessage = document.getElementById('statusMessage');
            const lastScannedProductDiv = document.getElementById('lastScannedProduct');
            const scanControls = document.getElementById('scanControls');
            const recentScansDiv = document.getElementById('recentScans');
            const recentScansList = document.getElementById('recentScansList');
            const scannerReadyMessage = document.getElementById('scannerReadyMessage');

            let html5QrCodeScan = null;
            let isScannerActive = false;
            let scanCooldown = false;
            let isPaired = false; // Will be set by server check

            function displayStatus(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type}`;
                statusMessage.style.display = 'block';
            }
            
            function addRecentScan(productName, code) {
                recentScansDiv.style.display = 'block';
                const listItem = document.createElement('li');
                listItem.textContent = `${new Date().toLocaleTimeString()}: ${productName || 'N/A'} (${code})`;
                recentScansList.prepend(listItem);
                if (recentScansList.children.length > 5) {
                    recentScansList.removeChild(recentScansList.lastChild);
                }
            }

            async function checkPairingStatus() {
                // This function assumes the mobile is already logged in.
                // The server will use the mobile's session to find its active pairing.
                try {
                    const response = await fetch('/billing/server.php?action=checkMobilePairingStatus'); // New action
                    const data = await response.json();
                    if (data.success && data.is_paired) {
                        isPaired = true;
                        scannerReadyMessage.textContent = 'Device is paired with POS. Ready to scan.';
                        scannerReadyMessage.style.color = 'var(--success)';
                        activateScannerBtn.style.display = 'block';
                    } else {
                        isPaired = false;
                        scannerReadyMessage.textContent = data.message || 'Device not actively paired. Please pair via the "Re-Pair" button or on your POS terminal.';
                        scannerReadyMessage.style.color = 'var(--error)';
                        activateScannerBtn.style.display = 'none';
                    }
                } catch (error) {
                    isPaired = false;
                    scannerReadyMessage.textContent = 'Error checking pairing status. Check network.';
                    scannerReadyMessage.style.color = 'var(--error)';
                    activateScannerBtn.style.display = 'none';
                    console.error("Pairing status check error:", error);
                }
            }
            checkPairingStatus(); // Check on load

            activateScannerBtn.addEventListener('click', () => {
                if (!isPaired) {
                    displayStatus('Device not paired. Please pair first.', 'error');
                    return;
                }
                startBarcodeScanner();
            });
            
            stopScannerBtn.addEventListener('click', stopBarcodeScanner);

            function startBarcodeScanner() {
                if (isScannerActive || !isPaired) return;

                displayStatus('Initializing scanner...', 'info');
                activateScannerBtn.style.display = 'none';
                scannerRegion.style.display = 'block';
                scanControls.style.display = 'flex';

                html5QrCodeScan = new Html5Qrcode("scanner-region");
                const config = { fps: 10, qrbox: { width: 280, height: 120 }, aspectRatio: 2.0 }; // Rectangular for barcodes

                html5QrCodeScan.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .then(() => {
                        isScannerActive = true;
                        displayStatus(`Scanner active. Point camera at product barcode.`, 'success');
                        requestWakeLock();
                    })
                    .catch(err => {
                        displayStatus(`Error starting scanner: ${err}.`, 'error');
                        console.error("Scanner start error:", err);
                        scannerRegion.style.display = 'none';
                        scanControls.style.display = 'none';
                        activateScannerBtn.style.display = 'block';
                    });
            }

            function stopBarcodeScanner() {
                if (html5QrCodeScan && isScannerActive) {
                    html5QrCodeScan.stop()
                        .then(() => {
                            isScannerActive = false;
                            displayStatus('Scanner stopped.', 'info');
                            scannerRegion.style.display = 'none';
                            scanControls.style.display = 'none';
                            activateScannerBtn.style.display = 'block';
                            if(html5QrCodeScan) html5QrCodeScan.clear();
                            releaseWakeLock();
                        })
                        .catch(err => {
                            displayStatus(`Error stopping scanner: ${err}`, 'error');
                        });
                } else {
                     isScannerActive = false;
                     scannerRegion.style.display = 'none';
                     scanControls.style.display = 'none';
                     activateScannerBtn.style.display = 'block';
                }
            }

            function onScanSuccess(decodedText, decodedResult) {
                if (scanCooldown || !isScannerActive) return; 
                scanCooldown = true;
                setTimeout(() => { scanCooldown = false; }, 1500); // 1.5 second cooldown

                displayStatus(`Scanned: ${decodedText}. Sending...`, 'info');
                lastScannedProductDiv.textContent = `Last: ${decodedText}`;

                const formData = new FormData();
                formData.append('action', 'submitScannedProduct');
                // The server will identify the pairing session using the mobile's PHP session (staff_user_id)
                formData.append('scanned_product_id', decodedText);
                // formData.append('quantity', 1); // Default quantity 1

                fetch('/billing/server.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayStatus(`Sent: ${data.product_name || decodedText}`, 'success');
                        addRecentScan(data.product_name, decodedText);
                    } else {
                        displayStatus(`Error: ${data.message || 'Failed to send.'}`, 'error');
                        addRecentScan(`Failed: ${data.message || 'Error'}`, decodedText);
                    }
                })
                .catch(error => {
                    displayStatus(`Network Error: ${error.message}`, 'error');
                    addRecentScan(`Network Error`, decodedText);
                });
            }

            function onScanFailure(error) { /* Usually quiet */ }
            
            let wakeLock = null;
            const requestWakeLock = async () => {
              if ('wakeLock' in navigator) {
                try {
                  wakeLock = await navigator.wakeLock.request('screen');
                  wakeLock.addEventListener('release', () => { /* console.log('Wake Lock released.'); */ });
                } catch (err) { /* console.error(`${err.name}, ${err.message}`); */ }
              }
            };
            const releaseWakeLock = () => {
                if(wakeLock !== null) {
                    wakeLock.release().then(() => { wakeLock = null; });
                }
            };
            document.addEventListener('visibilitychange', async () => {
              if (wakeLock !== null && document.visibilityState === 'visible' && isScannerActive) {
                await requestWakeLock();
              }
            });
        });
    </script>
</body>
</html>