<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile Barcode Scanner</title>
    <link rel="stylesheet" href="/billing/global.css?v=<?php echo time(); // For development cache busting ?>">
    <style>
        body { background-color: var(--bg-body); color: var(--text-primary); font-family: 'Inter', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; box-sizing: border-box; }
        .scanner-container { width: 100%; max-width: 600px; padding: 15px; box-sizing: border-box; text-align: center; }
        #scanner-region { width: 100%; max-width: 450px; min-height: 180px; border: 2px dashed var(--primary); background-color: var(--bg-surface-alt); margin: 10px auto; position: relative; }
        #scanner-region video { width: 100% !important; height: auto !important; }
        .status-message { margin-top: 10px; padding: 8px; border-radius: var(--border-radius-sm); font-weight: 500; font-size: 0.9em; }
        .status-message.success { background-color: var(--success-bg); color: var(--success-text-emphasis); border: 1px solid var(--success); }
        .status-message.error { background-color: var(--error-bg); color: var(--error-text-emphasis); border: 1px solid var(--error); }
        .status-message.info { background-color: var(--info-bg); color: var(--info-text-emphasis); border: 1px solid var(--info); }
        .btn { padding: .7rem 1.4rem; background-color: var(--primary); color: var(--text-on-primary); border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s; }
        .btn:hover { background-color: var(--primary-dark); }
        .btn:disabled { background-color: var(--border-color-strong); cursor: not-allowed; }
        .product-info { margin-top: 8px; font-size: 0.85em; color: var(--text-secondary); }
        #stopScannerBtn { background-color: var(--error); }
        #stopScannerBtn:hover { background-color: #b91c1c; }
        .controls { margin-top: 1rem; display: flex; gap: 10px; justify-content: center; }
        .scanner-page-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 1rem; padding: 0 5px; }
        .scanner-page-header .user-info-scanner { font-size: 0.9rem; color: var(--text-primary); }
        #recentScans { max-height: 150px; overflow-y: auto; font-size: 0.85rem; text-align: left;}
        #recentScansList li { padding: 3px 5px; border-bottom: 1px dashed var(--border-color-subtle); }
        #recentScansList li:last-child { border-bottom: none; }
        #activationInfo { padding: 10px; border-radius: var(--border-radius-sm); margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="scanner-container">
        <div class="scanner-page-header">
            <h1 class="page-title" style="font-size: 1.4rem; margin-bottom: 0; text-align: left;">Mobile Scanner</h1>
            <span class="user-info-scanner">User: <strong id="mobileUsernameDisplay">Loading...</strong></span>
        </div>
        
        <div id="activationInfo" class="glass p-3">
            <p id="activationStatusMessage">Checking activation status with POS terminal...</p>
            <button id="tryActivateScannerBtn" class="btn mt-2" style="display:none;">Try Activating Scanner</button>
        </div>

        <div id="scanner-region" style="display:none;"></div>
        <div id="statusMessage" class="status-message info" style="display:none;"></div>
        <div id="lastScannedProduct" class="product-info"></div>

        <div class="controls" style="display:none;" id="scanControls">
            <button id="stopScannerBtn" class="btn">Stop Camera</button>
        </div>

        <div id="recentScans" class="glass p-2 mt-2" style="display:none;">
            <h4 style="font-size: 0.9rem; margin-bottom: 5px;">Recent Scans:</h4>
            <ul id="recentScansList" style="list-style: none; padding: 0;"></ul>
        </div>
        <a href="/billing/logout.php" class="btn" style="background-color: var(--error); margin-top: 20px; font-size: 0.9rem;">Logout</a>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const scannerRegion = document.getElementById('scanner-region');
        const statusMessage = document.getElementById('statusMessage');
        const lastScannedProductDiv = document.getElementById('lastScannedProduct');
        const scanControls = document.getElementById('scanControls');
        const recentScansDiv = document.getElementById('recentScans');
        const recentScansList = document.getElementById('recentScansList');
        const activationStatusMessage = document.getElementById('activationStatusMessage');
        const tryActivateScannerBtn = document.getElementById('tryActivateScannerBtn');
        const mobileUsernameDisplay = document.getElementById('mobileUsernameDisplay');

        let html5QrCodeScan = null;
        let isScannerHardwareActive = false; // Camera is on
        let isSessionActiveForScanning = false; // Server confirmed this mobile can send scans
        let scanCooldown = false;
        let activationCheckInterval = null;

        function displayScanStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
        }

        function addRecentScan(productName, code) {
            recentScansDiv.style.display = 'block';
            const listItem = document.createElement('li');
            listItem.textContent = `${new Date().toLocaleTimeString()}: ${productName || 'N/A'} (${code})`;
            recentScansList.prepend(listItem);
            if (recentScansList.children.length > 5) {
                recentScansList.removeChild(recentScansList.lastChild);
            }
        }

        async function attemptToActivateScannerSession() {
            // This mobile device is already logged in.
            // It asks the server if the desktop (logged in as same user) has "activated" scanning.
            activationStatusMessage.textContent = 'Attempting to activate with POS...';
            tryActivateScannerBtn.style.display = 'none';
            try {
                const response = await fetch('/billing/server.php?action=activateMobileScannerSession'); // New Action
                const data = await response.json();

                if (data.success && data.session_activated) {
                    isSessionActiveForScanning = true;
                    activationStatusMessage.textContent = `Scanner activated by ${data.staff_username || 'POS'}. Ready to scan products.`;
                    activationStatusMessage.style.color = 'var(--success-text-emphasis)';
                    activationStatusMessage.parentElement.style.borderColor = 'var(--success)';
                    tryActivateScannerBtn.style.display = 'none';
                    if (!isScannerHardwareActive) { // Only start camera if not already running
                        startBarcodeScannerHardware();
                    }
                    if (activationCheckInterval) clearInterval(activationCheckInterval);
                    activationCheckInterval = null;
                     mobileUsernameDisplay.textContent = data.staff_username || 'Staff';
                } else {
                    isSessionActiveForScanning = false;
                    activationStatusMessage.textContent = data.message || 'POS terminal has not activated scanner mode for your account. Ask staff at POS to click "Activate Mobile Scanner".';
                    activationStatusMessage.style.color = 'var(--error-text-emphasis)';
                    activationStatusMessage.parentElement.style.borderColor = 'var(--error)';
                    tryActivateScannerBtn.style.display = 'block';
                    if(isScannerHardwareActive) stopBarcodeScannerHardware(); // Stop camera if session not active
                     mobileUsernameDisplay.textContent = data.current_user || 'Staff (Not Paired)';
                }
            } catch (error) {
                isSessionActiveForScanning = false;
                activationStatusMessage.textContent = 'Network error checking activation. Will retry.';
                activationStatusMessage.style.color = 'var(--error-text-emphasis)';
                tryActivateScannerBtn.style.display = 'block';
                console.error("Activation check error:", error);
            }
        }
        
        // Initial check and setup interval if not immediately activated
        attemptToActivateScannerSession();
        activationCheckInterval = setInterval(attemptToActivateScannerSession, 7000); // Check every 7 seconds

        tryActivateScannerBtn.addEventListener('click', attemptToActivateScannerSession);
        stopScannerBtn.addEventListener('click', stopBarcodeScannerHardware);

        function startBarcodeScannerHardware() {
            if (isScannerHardwareActive) return;
            displayScanStatus('Initializing camera...', 'info');
            scannerRegion.style.display = 'block';
            scanControls.style.display = 'flex';

            html5QrCodeScan = new Html5Qrcode("scanner-region");
            const config = { fps: 10, qrbox: { width: 280, height: 120 }, aspectRatio: 2.0 };

            html5QrCodeScan.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .then(() => {
                    isScannerHardwareActive = true;
                    displayScanStatus(`Camera active. Point at product barcode.`, 'success');
                    requestWakeLock();
                })
                .catch(err => {
                    displayScanStatus(`Error starting camera: ${err}.`, 'error');
                    console.error("Scanner start error:", err);
                    scannerRegion.style.display = 'none';
                    scanControls.style.display = 'none';
                });
        }

        function stopBarcodeScannerHardware() {
            if (html5QrCodeScan && isScannerHardwareActive) {
                html5QrCodeScan.stop()
                    .then(() => {
                        isScannerHardwareActive = false;
                        displayScanStatus('Camera stopped.', 'info');
                        scannerRegion.style.display = 'none';
                        scanControls.style.display = 'none';
                        if(html5QrCodeScan) html5QrCodeScan.clear();
                        releaseWakeLock();
                    })
                    .catch(err => { displayScanStatus(`Error stopping camera: ${err}`, 'error');});
            } else {
                 isScannerHardwareActive = false;
                 scannerRegion.style.display = 'none';
                 scanControls.style.display = 'none';
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (scanCooldown || !isScannerHardwareActive || !isSessionActiveForScanning) return; 
            scanCooldown = true;
            setTimeout(() => { scanCooldown = false; }, 1500);

            displayScanStatus(`Scanned: ${decodedText}. Sending...`, 'info');
            lastScannedProductDiv.textContent = `Last: ${decodedText}`;

            const formData = new FormData();
            formData.append('action', 'submitScannedProduct');
            formData.append('scanned_product_id', decodedText);

            fetch('/billing/server.php', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayScanStatus(`Sent: ${data.product_name || decodedText}`, 'success');
                        addRecentScan(data.product_name, decodedText);
                    } else {
                        displayScanStatus(`Server Error: ${data.message || 'Failed to send.'}`, 'error');
                        addRecentScan(`Failed: ${data.message || 'Error'}`, decodedText);
                         if(data.message && data.message.toLowerCase().includes("no active pairing")){
                            isSessionActiveForScanning = false; // Mark as not active
                            activationStatusMessage.textContent = 'Pairing lost or POS deactivated. Re-activate on POS.';
                            activationStatusMessage.style.color = 'var(--error-text-emphasis)';
                            tryActivateScannerBtn.style.display = 'block';
                            if(isScannerHardwareActive) stopBarcodeScannerHardware();
                        }
                    }
                })
                .catch(error => {
                    displayScanStatus(`Network Error: ${error.message}`, 'error');
                    addRecentScan(`Network Error`, decodedText);
                });
        }

        function onScanFailure(error) { /* Usually quiet */ }
        
        let wakeLock = null;
        const requestWakeLock = async () => { if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', () => {}); } catch (err) {} };
        const releaseWakeLock = () => { if(wakeLock !== null) wakeLock.release().then(() => { wakeLock = null; }); };
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible' && isScannerHardwareActive) await requestWakeLock(); });
    });
    </script>
</body>
</html>